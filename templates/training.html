<!-- templates/training.html -->
{% extends "base.html" %}

{% block title %}Training - Virtual Workout Buddy{% endblock %}

{% block content %}
<section class="training-section">
    <div class="training-header">
        <h2>Train Your Workout Buddy</h2>
        <p>Upload reference images to help improve exercise form analysis. Add examples of both proper and improper form for each exercise type.</p>
    </div>

    <!-- Training Statistics -->
    <section class="training-stats">
        <div class="stats-header">
            <h3>Current Training Data</h3>
            <button id="refresh-stats" class="refresh-stats-btn" title="Refresh Statistics">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M23 4v6h-6"></path>
                    <path d="M1 20v-6h6"></path>
                    <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10"></path>
                    <path d="M20.49 15a9 9 0 0 1-14.85 3.36L1 14"></path>
                </svg>
                Refresh
            </button>
        </div>
        <div class="stats-grid">
            {% for exercise, data in stats.items() %}
            <div class="stat-card">
                <h4>{{ exercise.title() }}</h4>
                <div class="stat-numbers">
                    <div class="stat-item proper">
                        <span class="count">{{ data.proper_references }}</span>
                        <span class="label">Proper Examples</span>
                    </div>
                    <div class="stat-item improper">
                        <span class="count">{{ data.improper_references }}</span>
                        <span class="label">Improper Examples</span>
                    </div>
                </div>
                <div class="total-stat">
                    Total: {{ data.total_references }} references
                </div>
            </div>
            {% endfor %}
        </div>
    </section>

    <!-- Upload Training Images -->
    <section class="training-upload">
        <h3>Add Training Images</h3>
        <div class="upload-form-container">
            <form id="training-form" class="training-form" enctype="multipart/form-data">
                <div class="form-row">
                    <div class="form-group">
                        <label for="training-exercise-select">Exercise Type:</label>
                        <select id="training-exercise-select" name="exercise_type" required>
                            <option value="">Select Exercise</option>
                            <option value="squat">Squat</option>
                            <option value="pushup">Push-up</option>
                            <option value="plank">Plank</option>
                            <option value="lunge">Lunge</option>
                            <option value="deadlift">Deadlift</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="form-quality-select">Form Quality:</label>
                        <select id="form-quality-select" name="form_quality" required>
                            <option value="">Select Quality</option>
                            <option value="proper">Proper Form</option>
                            <option value="improper">Improper Form</option>
                        </select>
                    </div>
                </div>

                <div class="file-upload-area">
                    <div class="upload-zone" id="training-upload-zone">
                        <div class="upload-icon">
                            <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                                <polyline points="17 8 12 3 7 8"></polyline>
                                <line x1="12" y1="3" x2="12" y2="15"></line>
                            </svg>
                        </div>
                        <p>Drag & drop training images here (multiple files supported)</p>
                        <p>or</p>
                        <label for="training-file-input" class="file-button">Choose Files</label>
                        <input type="file" id="training-file-input" name="file" accept="image/*" multiple required>
                        <div id="file-list" class="file-list"></div>
                    </div>
                </div>

                <div class="form-actions">
                    <button type="submit" class="submit-btn" id="submit-btn">
                        <span class="btn-text">Add Training Images</span>
                        <span class="btn-loading" style="display: none;">
                            <span class="spinner"></span> Uploading...
                        </span>
                    </button>
                </div>
            </form>
        </div>

        <!-- Upload Status -->
        <div id="upload-status" class="upload-status"></div>
    </section>

    <!-- Reference Images Gallery -->
    <section class="reference-gallery">
        <h3>Reference Images</h3>
        <div class="gallery-controls">
            <div class="filter-controls">
                <select id="gallery-exercise-filter">
                    <option value="">All Exercises</option>
                    <option value="squat">Squat</option>
                    <option value="pushup">Push-up</option>
                    <option value="plank">Plank</option>
                    <option value="lunge">Lunge</option>
                    <option value="deadlift">Deadlift</option>
                </select>
                <select id="gallery-quality-filter">
                    <option value="">All Qualities</option>
                    <option value="proper">Proper Form</option>
                    <option value="improper">Improper Form</option>
                </select>
                <button id="refresh-gallery" class="refresh-btn">Refresh Gallery</button>
            </div>
        </div>

        <div id="reference-images-grid" class="reference-grid">
            <!-- Images will be loaded here via JavaScript -->
        </div>
    </section>

    <!-- Instructions -->
    <section class="training-instructions">
        <h3>Training Guidelines</h3>
        <div class="instructions-grid">
            <div class="instruction-card">
                <h4>Proper Form Images</h4>
                <ul>
                    <li>Clear, well-lit photos showing correct technique</li>
                    <li>Full body visible in frame</li>
                    <li>Good examples of ideal positioning</li>
                    <li>Multiple angles and positions within the exercise</li>
                </ul>
            </div>
            <div class="instruction-card">
                <h4>Improper Form Images</h4>
                <ul>
                    <li>Examples of common mistakes</li>
                    <li>Poor alignment, incorrect positioning</li>
                    <li>Safety concerns that should be flagged</li>
                    <li>Various types of form errors</li>
                </ul>
            </div>
        </div>
    </section>
</section>

<style>
    .stats-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1.5rem;
}

.refresh-stats-btn {
    background: #6c757d;
    color: white;
    border: none;
    padding: 0.5rem 1rem;
    border-radius: 6px;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.9rem;
    transition: background-color 0.2s ease;
}

.refresh-stats-btn:hover {
    background: #5a6268;
}

.refresh-stats-btn svg {
    width: 16px;
    height: 16px;
}

.training-section {
    max-width: 1200px;
    margin: 0 auto;
    padding: 2rem 1rem;
}

.training-header {
    text-align: center;
    margin-bottom: 3rem;
}

.training-header h2 {
    color: #3a5bef;
    font-size: 2.5rem;
    margin-bottom: 1rem;
}

.training-header p {
    font-size: 1.1rem;
    color: #666;
    max-width: 600px;
    margin: 0 auto;
}

/* Training Stats */
.training-stats {
    margin-bottom: 3rem;
}

.training-stats h3 {
    color: #333;
    margin-bottom: 1.5rem;
    font-size: 1.5rem;
}

.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 1.5rem;
}

.stat-card {
    background: white;
    padding: 1.5rem;
    border-radius: 12px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    border: 1px solid #e9ecef;
    transition: transform 0.2s ease;
}

.stat-card:hover {
    transform: translateY(-2px);
}

.stat-card h4 {
    color: #333;
    margin-bottom: 1rem;
    font-size: 1.2rem;
    text-align: center;
}

.stat-numbers {
    display: flex;
    justify-content: space-around;
    margin-bottom: 1rem;
}

.stat-item {
    text-align: center;
}

.stat-item.proper .count {
    color: #28a745;
    font-size: 1.8rem;
    font-weight: bold;
    display: block;
}

.stat-item.improper .count {
    color: #dc3545;
    font-size: 1.8rem;
    font-weight: bold;
    display: block;
}

.stat-item .label {
    font-size: 0.85rem;
    color: #666;
    margin-top: 0.25rem;
}

.total-stat {
    text-align: center;
    font-weight: 600;
    color: #333;
    padding-top: 1rem;
    border-top: 1px solid #e9ecef;
}

/* Training Upload */
.training-upload {
    background: white;
    padding: 2rem;
    border-radius: 12px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    margin-bottom: 3rem;
    border: 1px solid #e9ecef;
}

.training-upload h3 {
    color: #333;
    margin-bottom: 1.5rem;
    font-size: 1.5rem;
}

.form-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1.5rem;
    margin-bottom: 1.5rem;
}

.form-group {
    display: flex;
    flex-direction: column;
}

.form-group label {
    font-weight: 600;
    margin-bottom: 0.5rem;
    color: #333;
}

.form-group select {
    padding: 0.75rem;
    border: 2px solid #e9ecef;
    border-radius: 6px;
    font-size: 1rem;
    transition: border-color 0.2s ease;
}

.form-group select:focus {
    outline: none;
    border-color: #3a5bef;
}

.file-upload-area {
    margin-bottom: 1.5rem;
}

.upload-zone {
    border: 2px dashed #ced4da;
    border-radius: 8px;
    padding: 2rem;
    text-align: center;
    transition: all 0.3s ease;
    background: #f8f9fa;
}

.upload-zone.dragover {
    border-color: #3a5bef;
    background: rgba(58, 91, 239, 0.05);
}

.upload-icon {
    color: #3a5bef;
    margin-bottom: 1rem;
}

.upload-zone p {
    margin: 0.5rem 0;
    color: #666;
}

.file-button {
    background: #3a5bef;
    color: white;
    padding: 0.75rem 1.5rem;
    border-radius: 6px;
    cursor: pointer;
    display: inline-block;
    transition: background-color 0.2s ease;
    margin-top: 1rem;
}

.file-button:hover {
    background: #2a4bd4;
}

.file-list {
    margin-top: 1rem;
    max-height: 200px;
    overflow-y: auto;
}

.file-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.75rem;
    margin: 0.5rem 0;
    background: white;
    border: 1px solid #e9ecef;
    border-radius: 6px;
}

.file-name {
    flex: 1;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    margin-right: 1rem;
}

.file-size {
    color: #666;
    font-size: 0.85rem;
    margin-right: 1rem;
}

.remove-file {
    background: #dc3545;
    color: white;
    border: none;
    width: 24px;
    height: 24px;
    border-radius: 50%;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.8rem;
}

.form-actions {
    text-align: center;
}

.submit-btn {
    background: #28a745;
    color: white;
    border: none;
    padding: 0.75rem 2rem;
    border-radius: 6px;
    font-size: 1rem;
    cursor: pointer;
    transition: background-color 0.2s ease;
    min-width: 200px;
}

.submit-btn:hover:not(:disabled) {
    background: #218838;
}

.submit-btn:disabled {
    background: #6c757d;
    cursor: not-allowed;
}

.spinner {
    display: inline-block;
    width: 16px;
    height: 16px;
    border: 2px solid rgba(255,255,255,.3);
    border-radius: 50%;
    border-top-color: #fff;
    animation: spin 1s ease-in-out infinite;
    margin-right: 0.5rem;
    vertical-align: middle;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

/* Upload Status */
.upload-status {
    margin-top: 1rem;
}

.status-message {
    padding: 1rem;
    border-radius: 6px;
    margin: 0.5rem 0;
}

.status-message.success {
    background: #d4edda;
    color: #155724;
    border: 1px solid #c3e6cb;
}

.status-message.error {
    background: #f8d7da;
    color: #721c24;
    border: 1px solid #f5c6cb;
}

.status-message.loading {
    background: #d1ecf1;
    color: #0c5460;
    border: 1px solid #bee5eb;
}

/* Reference Gallery */
.reference-gallery {
    background: white;
    padding: 2rem;
    border-radius: 12px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    margin-bottom: 3rem;
    border: 1px solid #e9ecef;
}

.reference-gallery h3 {
    color: #333;
    margin-bottom: 1.5rem;
    font-size: 1.5rem;
}

.gallery-controls {
    margin-bottom: 1.5rem;
}

.filter-controls {
    display: flex;
    gap: 1rem;
    align-items: center;
    flex-wrap: wrap;
}

.filter-controls select {
    padding: 0.5rem;
    border: 1px solid #ced4da;
    border-radius: 4px;
    min-width: 150px;
}

.refresh-btn {
    background: #6c757d;
    color: white;
    border: none;
    padding: 0.5rem 1rem;
    border-radius: 4px;
    cursor: pointer;
}

.refresh-btn:hover {
    background: #5a6268;
}

.reference-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
    gap: 1.5rem;
}

.reference-image-card {
    background: white;
    border: 1px solid #e9ecef;
    border-radius: 8px;
    overflow: hidden;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    transition: transform 0.2s ease;
    position: relative;
}

.reference-image-card:hover {
    transform: translateY(-2px);
}

.reference-image {
    width: 100%;
    height: 200px;
    object-fit: cover;
}

.image-info {
    padding: 1rem;
}

.exercise-type {
    font-weight: 600;
    color: #333;
    margin-bottom: 0.5rem;
}

.quality-badge {
    display: inline-block;
    padding: 0.25rem 0.75rem;
    border-radius: 20px;
    font-size: 0.8rem;
    font-weight: 600;
}

.quality-badge.proper {
    background: #d4edda;
    color: #155724;
}

.quality-badge.improper {
    background: #f8d7da;
    color: #721c24;
}

.timestamp {
    font-size: 0.8rem;
    color: #666;
    margin-top: 0.5rem;
}

.delete-btn {
    position: absolute;
    top: 0.5rem;
    right: 0.5rem;
    background: rgba(255,255,255,0.9);
    border: none;
    border-radius: 50%;
    width: 30px;
    height: 30px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    opacity: 0.7;
    transition: opacity 0.3s;
}

.delete-btn:hover {
    opacity: 1;
    background: white;
}

/* Instructions */
.training-instructions {
    background: white;
    padding: 2rem;
    border-radius: 12px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    border: 1px solid #e9ecef;
}

.training-instructions h3 {
    color: #333;
    margin-bottom: 1.5rem;
    font-size: 1.5rem;
}

.instructions-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 2rem;
}

.instruction-card {
    background: #f8f9fa;
    padding: 1.5rem;
    border-radius: 8px;
    border-left: 4px solid #3a5bef;
}

.instruction-card h4 {
    color: #333;
    margin-bottom: 1rem;
}

.instruction-card ul {
    list-style: none;
    padding: 0;
}

.instruction-card li {
    padding: 0.25rem 0;
    position: relative;
    padding-left: 1.5rem;
}

.instruction-card li:before {
    content: "•";
    color: #3a5bef;
    font-weight: bold;
    position: absolute;
    left: 0.5rem;
}

/* Loading and Error States */
.loading-spinner {
    text-align: center;
    padding: 3rem;
    color: #666;
    grid-column: 1 / -1;
}

.loading-spinner::after {
    content: "";
    display: inline-block;
    width: 20px;
    height: 20px;
    border: 3px solid rgba(0,0,0,.3);
    border-radius: 50%;
    border-top-color: #000;
    animation: spin 1s ease-in-out infinite;
    margin-left: 10px;
    vertical-align: middle;
}

.error-message {
    text-align: center;
    padding: 2rem;
    color: #dc3545;
    grid-column: 1 / -1;
}

.no-images {
    text-align: center;
    padding: 3rem;
    color: #666;
    grid-column: 1 / -1;
}

/* Progress Bar */
.upload-progress {
    margin-top: 1rem;
    padding: 1rem;
    background: #f8f9fa;
    border-radius: 6px;
    border: 1px solid #e9ecef;
}

.progress-bar {
    height: 6px;
    background: #e9ecef;
    border-radius: 3px;
    overflow: hidden;
    margin-top: 0.5rem;
}

.progress-fill {
    height: 100%;
    background: #28a745;
    width: 0%;
    transition: width 0.3s ease;
}

.progress-text {
    font-size: 0.85rem;
    color: #666;
}

/* Responsive Design */
@media (max-width: 768px) {
    .form-row {
        grid-template-columns: 1fr;
        gap: 1rem;
    }
    
    .filter-controls {
        flex-direction: column;
        align-items: stretch;
    }
    
    .stats-grid {
        grid-template-columns: 1fr;
    }
    
    .instructions-grid {
        grid-template-columns: 1fr;
    }
    
    .reference-grid {
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
    }
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const trainingForm = document.getElementById('training-form');
    const uploadZone = document.getElementById('training-upload-zone');
    const fileInput = document.getElementById('training-file-input');
    const fileList = document.getElementById('file-list');
    const uploadStatus = document.getElementById('upload-status');
    const galleryGrid = document.getElementById('reference-images-grid');
    const exerciseFilter = document.getElementById('gallery-exercise-filter');
    const qualityFilter = document.getElementById('gallery-quality-filter');
    const refreshBtn = document.getElementById('refresh-gallery');
    const submitBtn = document.getElementById('submit-btn');
    const btnText = submitBtn.querySelector('.btn-text');
    const btnLoading = submitBtn.querySelector('.btn-loading');

    let selectedFiles = [];

    // File input change handler
    fileInput.addEventListener('change', function(e) {
        selectedFiles = Array.from(e.target.files);
        updateFileList();
    });

    // Update file list display
    function updateFileList() {
        fileList.innerHTML = '';
        if (selectedFiles.length > 0) {
            selectedFiles.forEach((file, index) => {
                const fileItem = document.createElement('div');
                fileItem.className = 'file-item';
                fileItem.innerHTML = `
                    <span class="file-name">${file.name}</span>
                    <span class="file-size">(${formatFileSize(file.size)})</span>
                    <button type="button" class="remove-file" data-index="${index}">×</button>
                `;
                fileList.appendChild(fileItem);
            });

            // Add remove file functionality
            document.querySelectorAll('.remove-file').forEach(btn => {
                btn.addEventListener('click', function() {
                    const index = parseInt(this.dataset.index);
                    selectedFiles.splice(index, 1);
                    updateFileList();
                    // Update the actual file input
                    const dt = new DataTransfer();
                    selectedFiles.forEach(file => dt.items.add(file));
                    fileInput.files = dt.files;
                });
            });
        }
    }

    // Format file size
    function formatFileSize(bytes) {
        if (bytes === 0) return '0 Bytes';
        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }

    // Drag and drop functionality
    uploadZone.addEventListener('dragover', function(e) {
        e.preventDefault();
        this.classList.add('dragover');
    });

    uploadZone.addEventListener('dragleave', function(e) {
        e.preventDefault();
        this.classList.remove('dragover');
    });

    uploadZone.addEventListener('drop', function(e) {
        e.preventDefault();
        this.classList.remove('dragover');
        if (e.dataTransfer.files.length) {
            selectedFiles = Array.from(e.dataTransfer.files);
            // Update the actual file input
            const dt = new DataTransfer();
            selectedFiles.forEach(file => dt.items.add(file));
            fileInput.files = dt.files;
            updateFileList();
        }
    });

    // Add this function to update stats
    function updateTrainingStats() {
        fetch('/training_stats')
        .then(response => response.json())
        .then(stats => {
            // Update the stats display without reloading the page
            updateStatsDisplay(stats);
        })
        .catch(error => {
            console.error('Error updating stats:', error);
        });
    }

    // Add this function to update the stats display
    function updateStatsDisplay(stats) {
        const statsGrid = document.querySelector('.stats-grid');
        if (!statsGrid) return;
        
        let html = '';
        for (const [exercise, data] of Object.entries(stats)) {
            html += `
                <div class="stat-card">
                    <h4>${exercise.charAt(0).toUpperCase() + exercise.slice(1)}</h4>
                    <div class="stat-numbers">
                        <div class="stat-item proper">
                            <span class="count">${data.proper_references}</span>
                            <span class="label">Proper Examples</span>
                        </div>
                        <div class="stat-item improper">
                            <span class="count">${data.improper_references}</span>
                            <span class="label">Improper Examples</span>
                        </div>
                    </div>
                    <div class="total-stat">
                        Total: ${data.total_references} references
                    </div>
                </div>
            `;
        }
        statsGrid.innerHTML = html;
    }

    // Update the form submission success handler
    trainingForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        
        // Basic validation
        if (selectedFiles.length === 0) {
            showStatus('Please select at least one file', 'error');
            return;
        }
        
        // Validate files before upload
        const validationIssues = validateFiles(selectedFiles);
        if (validationIssues.length > 0) {
            showStatus(`File validation failed: ${validationIssues.join(', ')}`, 'error');
            return;
        }
        
        // Show loading state
        setLoadingState(true);
        
        console.log(`Uploading ${selectedFiles.length} files:`, selectedFiles.map(f => ({name: f.name, size: f.size, type: f.type})));
        
        // Create form data
        const formData = new FormData();
        formData.append('exercise_type', document.getElementById('training-exercise-select').value);
        formData.append('form_quality', document.getElementById('form-quality-select').value);
        
        // Append each file
        selectedFiles.forEach((file, index) => {
            console.log(`- Appending file ${index}:`, file.name, file.size, file.type);
            formData.append('file', file, file.name);
        });
        
        // Show upload progress
        showUploadProgress(selectedFiles.length);
        
        try {
            const response = await fetch('/upload_training', {
                method: 'POST',
                body: formData
            });
            
            const data = await response.json();
            console.log('Upload response:', data);
            
            if (data.success) {
                let successMessage = data.message;
                
                // Show individual file errors if any
                if (data.errors && data.errors.length > 0) {
                    const errorList = data.errors.map(error => `<li>${error}</li>`).join('');
                    successMessage += `<div style="margin-top: 10px;"><strong>Files with errors:</strong><ul style="margin: 5px 0; padding-left: 20px;">${errorList}</ul></div>`;
                }
                
                showStatus(successMessage, 'success');
                
                // Reset form and refresh data
                trainingForm.reset();
                selectedFiles = [];
                updateFileList();
                refreshGallery();
                
                // UPDATE STATS AFTER SUCCESSFUL UPLOAD
                updateTrainingStats();
                
            } else {
                // Complete failure
                let errorMessage = data.error || 'Upload failed';
                if (data.details && data.details.length > 0) {
                    const detailList = data.details.map(detail => `<li>${detail}</li>`).join('');
                    errorMessage += `<ul style="margin: 5px 0; padding-left: 20px;">${detailList}</ul>`;
                }
                showStatus(errorMessage, 'error');
            }
            
        } catch (error) {
            console.error('Upload error:', error);
            showStatus(`Upload failed: ${error.message || 'Network error'}`, 'error');
        } finally {
            setLoadingState(false);
            hideUploadProgress();
        }
    });

    function setLoadingState(loading) {
        submitBtn.disabled = loading;
        if (loading) {
            btnText.style.display = 'none';
            btnLoading.style.display = 'inline';
        } else {
            btnText.style.display = 'inline';
            btnLoading.style.display = 'none';
        }
    }

    function showStatus(message, type) {
        uploadStatus.innerHTML = `<div class="status-message ${type}">${message}</div>`;
    }

    function showUploadProgress(totalFiles) {
        uploadStatus.innerHTML = `
            <div class="status-message loading">
                <div>Uploading ${totalFiles} training images...</div>
                <div class="upload-progress">
                    <div>Processing files: <span class="progress-text">0/${totalFiles}</span></div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="progress-fill"></div>
                    </div>
                </div>
            </div>
        `;
    }

    function hideUploadProgress() {
        const progressMessage = uploadStatus.querySelector('.status-message.loading');
        if (progressMessage) {
            progressMessage.remove();
        }
    }

    function validateFiles(files) {
        const issues = [];
        const maxSize = 16 * 1024 * 1024; // 16MB
        
        files.forEach(file => {
            if (file.size === 0) {
                issues.push(`${file.name}: File is empty`);
            }
            if (file.size > maxSize) {
                issues.push(`${file.name}: File too large (${formatFileSize(file.size)})`);
            }
            if (!file.type.startsWith('image/')) {
                issues.push(`${file.name}: Not an image file`);
            }
        });
        
        return issues;
    }

    // Gallery functionality
    function refreshGallery() {
        const exercise = exerciseFilter.value;
        const quality = qualityFilter.value;
        
        galleryGrid.innerHTML = '<div class="loading-spinner">Loading reference images...</div>';
        
        if (exercise && quality) {
            loadReferenceImages(exercise, quality);
        } else {
            loadAllReferenceImages();
        }
    }

    function loadReferenceImages(exercise, quality) {
        fetch(`/reference_images/${exercise}/${quality}`)
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                throw new Error(data.error);
            }
            displayImages(Array.isArray(data) ? data : []);
        })
        .catch(error => {
            galleryGrid.innerHTML = `<div class="error-message">Error loading images: ${error.message}</div>`;
        });
    }

    function loadAllReferenceImages() {
        const exercises = ['squat', 'pushup', 'plank', 'lunge', 'deadlift'];
        const qualities = ['proper', 'improper'];
        const allPromises = [];

        exercises.forEach(exercise => {
            qualities.forEach(quality => {
                allPromises.push(
                    fetch(`/reference_images/${exercise}/${quality}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.error) {
                            console.warn(`Error loading ${exercise}/${quality}:`, data.error);
                            return [];
                        }
                        return Array.isArray(data) ? data : [];
                    })
                    .catch(error => {
                        console.warn(`Failed to load ${exercise}/${quality}:`, error);
                        return [];
                    })
                );
            });
        });

        Promise.all(allPromises)
        .then(results => {
            const allImages = results.flat();
            displayImages(allImages);
        })
        .catch(error => {
            galleryGrid.innerHTML = `<div class="error-message">Error loading images: ${error}</div>`;
        });
    }

    function displayImages(images) {
        if (!images || images.length === 0) {
            galleryGrid.innerHTML = '<div class="no-images">No reference images found.</div>';
            return;
        }

        let html = '';
        images.forEach(img => {
            const exercise = img.exercise || 'unknown';
            const quality = img.quality || 'unknown';
            const qualityClass = quality === 'proper' ? 'proper' : 'improper';
            
            html += `
                <div class="reference-image-card">
                    <img src="${img.image}" alt="${exercise} ${quality}" class="reference-image">
                    <div class="image-info">
                        <div class="exercise-type">${exercise.charAt(0).toUpperCase() + exercise.slice(1)}</div>
                        <div class="quality-badge ${qualityClass}">${quality.charAt(0).toUpperCase() + quality.slice(1)}</div>
                        <div class="timestamp">${new Date(img.timestamp).toLocaleDateString()}</div>
                    </div>
                    <button class="delete-btn" data-file-path="${img.file_path}" data-exercise="${exercise}" data-quality="${quality}">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <polyline points="3 6 5 6 21 6"></polyline>
                            <path d="m19 6-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6"></path>
                            <path d="m9 6 1-2h4l1 2"></path>
                        </svg>
                    </button>
                </div>
            `;
        });
        
        galleryGrid.innerHTML = html;
        
        // Add delete functionality
        document.querySelectorAll('.delete-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                if (confirm('Are you sure you want to delete this reference image?')) {
                    deleteReferenceImage(this);
                }
            });
        });
    }

    function deleteReferenceImage(button) {
        const filePath = button.dataset.filePath;
        const exercise = button.dataset.exercise;
        const quality = button.dataset.quality;
        
        fetch('/delete_reference', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                file_path: filePath,
                exercise_type: exercise,
                form_quality: quality
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showStatus('Reference image deleted successfully', 'success');
                refreshGallery();
                // UPDATE STATS AFTER DELETE TOO
                updateTrainingStats();
            } else {
                showStatus(`Error deleting image: ${data.error}`, 'error');
            }
        })
        .catch(error => {
            showStatus(`Delete failed: ${error}`, 'error');
        });
    }

    // Event listeners
    refreshBtn.addEventListener('click', refreshGallery);
    exerciseFilter.addEventListener('change', refreshGallery);
    qualityFilter.addEventListener('change', refreshGallery);

    // Initial load
    refreshGallery();
});

// Add refresh stats button functionality
const refreshStatsBtn = document.getElementById('refresh-stats');
if (refreshStatsBtn) {
    refreshStatsBtn.addEventListener('click', function() {
        this.classList.add('loading');
        updateTrainingStats();
        // Remove loading class after a short delay
        setTimeout(() => {
            this.classList.remove('loading');
        }, 1000);
    });
}

// Optional: Add loading animation for refresh button
const style = document.createElement('style');
style.textContent = `
    .refresh-stats-btn.loading svg {
        animation: spin 1s linear infinite;
    }
`;
document.head.appendChild(style);
</script>
{% endblock %}